
### 참고 자료 

[[3. Resource_리소스/Node.js/KGA_14주~17주차(6월) - 복사본/2305310927_수요일_node.js_AWS 배포_도메인연결_EC2방식]]
[[3. Resource_리소스/Node.js/KGA_14주~17주차(6월) - 복사본/230601_75930_목요일_node.js_AWS 도메인배포_nginx 사용_]]



## 해결해야 하는 사항 

- aws 랑 mysql 이랑 연결은 되었는데, not be fetched 라는 게 뜸
[[5. githubSync_gitBook/12_KGA_웹개발 블록체인 교육과정/KGA_08월(nobroker_react 프로젝트)/230816_노브로커_AWS배포#^a89b6f]]

![](https://i.imgur.com/vI3Mpbd.png)




## [이슈 사항] 배포 질문 

### 문제 상황
https://clipchamp.com/watch/u6xZiLgwyN8
<div style="position:relative;width:fit-content;height:fit-content;">
            <a style="position:absolute;top:20px;right:1rem;opacity:0.8;" href="https://clipchamp.com/watch/u6xZiLgwyN8?utm_source=embed&utm_medium=embed&utm_campaign=watch">
                <img loading="lazy" style="height:22px;" src="https://clipchamp.com/e.svg" alt="Made with Clipchamp" />
            </a>
            <iframe allow="autoplay;" allowfullscreen style="border:none" src="https://clipchamp.com/watch/u6xZiLgwyN8/embed" width="640" height="360"></iframe>
        </div>


- `http://www.busiman.shop/api/list/test` 요청시 오류 화면 
![](https://i.imgur.com/ev1dnz5.png)



### 질문 내용 
``` bash
교수님 질문!!!

지금 한 서버에서 백엔드, 프론트 엔드를 배포했고,

백엔드는 8080 포트로 열었고 netstat -tuln | grep 8080 명령어로 포트 열려있는거 확인했습니다.

리액트 프로젝트도 build된 폴더를 /var/www/html/react-build 폴더에 옮겼습니다.

프록시 관련 파일은 '/etc/nginx/sites-enabled/default' 파일이고, 여기에서 프론트&백엔드 요청 경로 설정했습니다!
프론트의 root폴더도 설정했습니다.

그래서 배포한 도메인으로 접속하면 작성한 리액트 코드는 기능하는데, 화면에도 출력됩니다.

문제는, 프론트에서 백엔드로 요청 보낼때 axios 에러가 뜹니다.. 404에러

뭐가 문제인지 모르겠어염
```


### 교수님이 해주신 부분 
``` js
= , ~ 을 설정하여, api 하위 요소가 붙어서, 요청이 들어갈 수 있는 가능성을 알게 됨  
```
![](https://i.imgur.com/nW6k81z.png)

![](https://i.imgur.com/wzwLyxZ.png)



![](https://i.imgur.com/HmuE9cQ.png)



#### 참고하신 자료들 
```
[블로그]
https://server-talk.tistory.com/311

[nginx 공식문서]
https://nginxstore.com/docs/nginx/

```




### 조금 더 해야하는 것 
``` js
[문제 상황]
현재, 제대로 작동이 된다면, 이 코드가 정상 작동 되어서, 콘솔창에 "test 요청 들어옴" 이 찍혀 나와야 함. 
	router.get("/test", (req, res)=>{
	    console.log("test요청 들어옴");
	    return res.json({test : "test", __dirname});
	});

예전 처럼 404가 뜨지는 않음. 
그런데, 콘솔에 "test요청 들어옴" 이 뜨는게 아니라, 
'index.html' 안에 있는게 다 들어옴. 
```




### 해결 과정 

#### 1. 하위 요소로 요청하기 

```
이건, 8080 포트에 요청하면, 성공적으로 통신할 수 있다는 점에 착안해서, 아현님이 axios 통신할 때, 무조건 8080 이 붙게 함. 

즉, 도메인 설정할 때 무조건 8080 이 붙게 함 
```

- 8080 이 붙었을 때 작동하는 방식
![](https://i.imgur.com/6m4vlcX.png)

- 수정한 것 👇👇 
![](https://i.imgur.com/iZhIrvw.png)


#### 2. sequelize 와 mysql 연동 문제 

1) not fetched 문제
``` bash
유저 권한 설정에는 1) 어떤 유저가 접속하게 할지 2) 어떤걸 할 수 있게 할지 가 관련되어 있음. 

오류 메시지는 
admin 유저를 만들었을 때, 와일드 카드를 부여해서 -> 모든 ip 에서 접속할 수 있게 함 
그런데도 오류 메시지는 'Error Code: 1142 SELECT command denied to user 'admin'@'221.149.9.93' for table 'user_variables_by_thread' 이렇게 뜸'

'mysql> USE performance_schema;' 를 통해, 해당 database 하위에 어떤 table 이 있는지 확인 
그 결과, 'performance_schema' database 안에 'user_variables_by_thread' 테이블이 있었고, 
mysql> GRA NT SELECT ON performance_schema.user_variables_by_thread TO 'admin'@'221.149.9.93'; 이걸로 권한 부여 
```


2) sequelize 에 의해 SQL 테이블이 안 만들어지고 있음. 
``` bash
원인은 'ENV 파일 만드는 방식' 에 있었음. 

즉, 처음에 ssh 방식으로 만들 때, 
	chmod 600 을 부여하고 -> 그 다음 권한 부여를 하고 -> env 를 작성 (ssh 에서 밖에 env 를 수정 못 하는 상황)
	그런데, ssh 방식이 불편해서,  'EC2 인스턴스 연결' 을 선택함 
	그런데, 'chmod 에 의해 수정 권한' 이 ssh 에 있다는 걸 간과하고, 계속 EC2 방식에서 env 파일 수정을 진행 
	다시 ssh 버전에서 올바르게 수정하고 -> sequelize 연결 완료 
```



3) app.js 에서 sequelize, requirerk 제멋대로 삭제되었음. 
 ```

```





### [230818 배포] 문제 상황 
```
현재, kakao map api 가 안 되고 있음 
map api 를 env 에 받아와서 -> 사용하는데, 안 됨 

env 를 스쳐도 에러나는데 

지금 문자열로 뺐어도, 다 안빠진게 있는 것 같아 

더미 데이터를 만들어서 이제 테스트 ⭐⭐⭐ 

권한이 문제면, chmod 를 제거하자 

로컬 테스트할 때의 api 랑 
배포 api 랑 구분해야 함 


public > index.html 에서 이부분 확인 
`<script>` 태그의 `async` 속성은 스크립트가 병렬로 다운로드되고, 스크립트 다운로드가 HTML 파싱을 방해하지 않도록 하는 것이 좋습니다. 그러나 스크립트 간의 종속성이 있거나 실행 순서가 중요한 경우 `async` 속성을 사용하지 않는 것이 좋습니다.

```





---
## 프록시 경로 수정 

^09ba52

```
✅ 지원님이 이미, 프록시 경로 수정을 다 마무리 해주신 상태 
✅ 나중에도 이걸 먼저 해야 함 
음... 아직 프록시을 이해 못 했음.
```


- 프록시 경로 수정하는 법 
```
axios.defaults.baseURL = 'http://localhost:8080';
	-> axios.defaults.baseURL = 'http://busiman.shop';
```


- 프록시 경로 수정할 부분 1 
![](https://i.imgur.com/dCMliEu.png)

```
localhost 대신 -> 탄력적 ip 주소 넣으면 됨. 
```


- 프록시 경로 수정할 부분 2
![](https://i.imgur.com/HrucZ57.png)


- 특히 이 부분 axios 설정으로 인해 도메인 같은 부분이 바뀜 ⭐⭐⭐ 
![](https://i.imgur.com/vOKymf7.png)





## EC2 인스턴스 만들고 연결하기 
### 요약 
``` CSS
1. EC2 인스턴스 들어가기 
2. 체크할 것 
	- '지역 = 서울' 인지 여부 
	- 이름 = 자유 기재 
	- 사용운영 체재 = '우분투 / 프리미어' (필수) ⭐⭐⭐⭐⭐⭐ 
	- 키페어 
		- 키페어 이름 자유롭게 설정 
		- RSA, .per 으로 설정 
		- 생성된 mykey.pem 파일을 '전송' 할 일이 있으면, '반드시 usb로' (이메일하거나, 노출되면 안 돼) | ⭐⭐⭐ 키 파일 보관 잘 하기 
	- 네트워크 설정 
		- 보안그룹 설정 : HTTP, HTTPS, MYSQL | ⭐⭐⭐ MYSQL 필수 
		- 원본 : 0.0.0./0 으로 설정 

3. 다 만들어지면 > EC2 전체 화면에서 > 우측 상단 클릭 

4. 수업에서는 SSH 클라이언트로 연결
```


### 1. 가입하고 나서 > EC2 인스턴스 로 들어가보기 
![](https://i.imgur.com/HBknzcw.png)


<br>

### 2.  지역 = 서울 
	- 왜냐면, 가까운게 빠르니까 
![](https://i.imgur.com/YWpBea4.png)

<br>

### 3. 인스턴스 시작 
![](https://i.imgur.com/lrBq7UD.png)


<br>

### 4. 이름 설정  
![](https://i.imgur.com/U9atdpd.png)

<br>
### 5.  사용하고 싶은 운영체제 선택
	- 우분투 / 프리티어 (사용하면 돈이 안 나감)
![](https://i.imgur.com/elZz2Sy.png)

<br>

### 6. 키 페어 | 새 키 페어 생성 누르면 됨
```
- 옮겨야 하면 usb 에 옮겨야 함 ⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐  
	- 절대로, 메일, 로 보내면 안 돼 
	- '키페어 파일' 이 받아짐 
	- 이 파일 전달하려면 usb 필수 ⭐⭐⭐⭐⭐⭐ 
```

![](https://i.imgur.com/MuoZS8L.png)

![](https://i.imgur.com/lWmEVGQ.png)
![[mykey.pem]]
![[nobrokerkey.pem]]
![[noBroker.pem]]

![[nobroker_3 1.pem]]


- 다운 받아진 모습 
![](https://i.imgur.com/PkTPlto.png)



<br>

### 7. 네트워크 설정
```
우상단에 있는 '편집' 을 눌러야 아래로 넘어감 ⭐⭐ 
```
![](https://i.imgur.com/MYW5XDn.png)


```
ssh 설정  
	- TCP 프로토콜 포트 범위 22 
	- 기본으로 가지고 있는 디폴트 포트 라고 생각하면 된다. 
	- 인스턴스에 접근하기 위해서 
```
![](https://i.imgur.com/ksT1NOS.png)

<br>
### 8. 보안 그룹 설정 | ⭐⭐⭐ MYSQL 도 빼먹지 말고 할 것 
```
- `보안 그룹 규칙 추가` 눌러서 > HTTP, HTTPS, MYSQL 추가
- 그리고 서버 포트를 8080 으로 했으면, 그것도 꼭 추가 ⭐⭐⭐
- 접두사도 0.0.0./0 으로 설정 
```

![](https://i.imgur.com/B2Qipss.png)

![](https://i.imgur.com/NdQNfZ1.png)

![](https://i.imgur.com/Wt0lqxI.png)

![](https://i.imgur.com/qOYvk2e.png)
![](https://i.imgur.com/2X3OEKQ.png)



### 9. 인스턴스 시작

![](https://i.imgur.com/2V3afus.png)

![](https://i.imgur.com/42zrtH2.png)



<br>

### 10. 연결 
	- 만들어지면 > EC2 전체 화면으로 가서 > 우측 상단에 `연결` 클릭  
![](https://i.imgur.com/3TNJOi3.png)

<br>

- ec2 연결도 가능 (지금은 안 할 것 임)
![](https://i.imgur.com/DaHnrZD.png)

<br>

- 수업에서는 ssh 연결 로 해볼것 임 | 이 버전은 수업용, 이후 배포는 EC2 인스턴스 방식에 따라서 
![](https://i.imgur.com/l7UygYr.png)






## 'EC2 인스턴스 방식' 연결 (그 이전버전은 수요일 필기에 있음 (230531))

^32c422

- 기본 인스턴스 만들고, key 파일 가져오기 
![](https://i.imgur.com/q2C7CwB.png)


- ec2 인스턴스 연결
![](https://i.imgur.com/eBVzWA2.png)
 ^5aad90

- 이제 이 창이, SSH 로 연결한 창과 동일 
![](https://i.imgur.com/BBAUvh6.png)




## ubuntu 디렉토리에가서 -> git 설치 
``` bash
[ubuntu 디렉토리로 이동]
cd /home/ubuntu

[혹은 ls -a 로 파일 확인하고 이동]
cd ../ 
ls -a 

[도착하면]
git init
```



- [예시1] git init 에서 permission denied 가 떴는데, 그건, 상위폴더로 이동할 때, root 까지 간거고, 우리에게 할당된건 ubuntu 이기 때문에 여기서 멈춰야함
![](https://i.imgur.com/yHjI4qd.png) ^de2233

- [예시 2] 노브로커 프로젝트에서 진행
![](https://i.imgur.com/itxpIM3.png)


![](https://i.imgur.com/xI104Wa.png)




## nvm 설치 후 git 연결 | 1) nvm 설치하고, 2) git clone 해서 git 연결하고 3)  backend, frontend 의 package.json 있는 폴더에서 의존성 설치(npm install) 하기 

^c1c930

``` bash
# 노드 설치 
# nvm 노드 버전 매니저 
    // node.js 설치 하고, 다른 버전으로 설치 할 때, 
    // 삭제하고, 다시 설치할 필요 없이, 버전관리가 편하다. 
    // 원하는 버전을 설치 받고, 바로 스위치 가능 

    # 첫 번째 설치 | `install.sh` 스크립트를 다운로드만 하고 실행하지 않음
	#curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.37.2/install.sh
    
    # 🔵 두 번째 방법으로 설치 | 👇 아래 코드를 그대로, 넣으면 설치됨 | `install.sh` 스크립트를 다운로드하고 실행까지 함 | 🔵 두 번째 방법으로 하면 됨. 
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.37.2/install.sh | bash 

    # 소스 파일 적용 | bashrc 😥😥😥 이게 설정이 안 되어 있었다는 것? 😥😥😥  
	source ~/.bashrc


    # 전체 목록 확인
	nvm list-remote
		# 에러날 수 있음 -> 당황하지 않고 다음으로 넘어가기

    # 원하는 버전을 선택하고 설치 
    nvm install 16(여기서 숫자 버전)

	# nobroker 프로젝트 git 을 복사해오기 
		# EC2 에서 어떤 폴더에 할지 고민인데, 지금은 우선 Ubuntu 안에 하자
		# [tip] 이 순간, cd ~ 을 하면, 가장 home 으로 가게 됨. | 이게 ubuntu 폴더 임. 
		git clone https://github.com/zam0ng/React_Project_NoBroker.git
	
	# ls -a 하면, 만들어진 프로젝트가 있는데 거기로 이동 -> package.json 이 있는 곳으로 이동해서 npm install 로 의존성 설치 
	cd React_Project_NoBroker
	cd front 그리고 cd backend
	npm install 
	
    # 노드 모듈 설치 
    npm i 
    npm start 
```


- 두 번째 방법으로 설치한 화면 
![](https://i.imgur.com/bj33tvu.png)


- ubuntu 디렉토리에 git clone 해서 가져옴 
```
 git clone https://github.com/zam0ng/React_Project_NoBroker.git
```
![](https://i.imgur.com/JcxyS66.png)


- ls -a 하면, 만들어진 프로젝트가 있는데 거기로 이동 -> package.json 이 있는 곳으로 이동해서 npm install 로 의존성 설치 
```
	// ls -a 하면, 만들어진 프로젝트가 있는데 거기로 이동 -> package.json 이 있는 곳으로 이동해서 npm install 로 의존성 설치 
	cd React_Project_NoBroker
	cd front 또는 cd backend
	npm install 
```
![](https://i.imgur.com/Ck0LsOl.png)





- 이 주소는 우리가 따로 설정한 적이 없음. 
- 인스턴스를 실행하거나, 다시 실행하면, '동적으로 ip 주소' 가 할당된다. 
- 껐다, 켰다, 하면, 바뀜. == `동적임`
- 그런데, 만약, 도메인 연결을 했는데, 바뀌면, 연결이 끊기는거잖아! 
- so, 바뀌면 안 돼. 
- so, `탄력적 ip` 를 설정하면 > `고정 ip` 를 할당 받을 수 있다. 
- 그러면, 인스턴스를 다시 실행해도, 도메인이 바뀌지 않는다! 
![](https://i.imgur.com/SHoO9qw.png)





## 탄력적 ip 추가 하기 

1. 탄력적 IP 주소 할당 
![](https://i.imgur.com/lvOS0kV.png)
![](https://i.imgur.com/4b0h5wS.png)

![](https://i.imgur.com/DcWW79I.png)



2. 할당받은 주소랑 인스턴스랑 연결 | 오른쪽 상단에 `탄력적 IP 연결` 누르기 
![](https://i.imgur.com/WAt79Nj.png)


3. 지금 실행시킨 인스턴스 연결하기 
![](https://i.imgur.com/FRSQ1Xl.png)

- 지금 연결한걸로 선택 
![](https://i.imgur.com/HjUvlK3.png)


4. 그러면, `고정 ip` 가 생김 | 이때 `elastic` 이 생김 
```
고정 IP 주소는 할당된 IPv4 주소에 해당.
위에서 주어진 정보 중에서 "✅할당된 IPv4 주소✅" 항목에 나와 있는 IP 주소가 고정 IP 주소
고정 IP 주소는 AWS에서 Elastic IP 주소라고도 부름. 
```

![](https://i.imgur.com/EyvvyIR.png)

![](https://i.imgur.com/16JRl5C.png)

- 그러면, 들어갈 수 있어 
![](https://i.imgur.com/8Lj5Kok.png)





## Route 53 에서 퍼블릭 ipv4 값을 넣어주기 

![](https://i.imgur.com/m8XtXJG.png)




## Nginx 를 사용해서, 프록시 설정 | ⭐⭐⭐ 여기 오류가 많음. 


### 리버스 프록시 기본 개념 
```
프록시는 '대신' 이라는 뜻 
뭘 대신? 
통신을 할 때, '중간' 에서 '대신' 통신해주는 역할 

즉, '프록시' 는 클라와 서버가 '통신' 할 때, '중계역할' 을 해준다. ('중계서버')

클라이언트는 프록시 서버를 서버로 알고 있음. 
서버는 프록시 서버를 클라이언트로 알고 있음. 

서버의 위치에 따라서 '포워드 프록시' , '리버스 프록시' 로 구분된다. 
오늘 쓸 것은 '리버스 프록시' 임 
```

- 리버스 프록시 
``` css
리버스 프록시는 
1) '프록시 서버'가 '서버의 앞'에 위치하고 
2) 클라이언트가 서버에 요청을 하면, 리버스 프록치가 호출되고 
3) 리버스 프록시는 서버에게 요청을 해서 응답을 받고, 클라이언트에게 전송

즉, 
클라이언트가 직접 서버에 요청하는게 아니고, 
프록시 서버가 요청을 받고, 
프록시 서버가 대신 '진짜 서버' 에게 요청해서 
진짜 서버의 응답을 받게 된다. 

이렇게 하면, '서버를 감출 수 있다.' 
따라서, '보안에 좋음'

이 과정을 Nginx 를 사용해서, 리버스 프록시 만들어보자. 

즉, 
클라이언트 -> 인터넷 -> 프록시 서버 -> 서버 
서버 -> 프록시 서버 -> 인터넷 -> 클라이언트 
```


- 예시 
```
클라이언트가 80번 포트로 요청을 보냄 

서버 안에 프록시가 요청을 받음 

프록시가 express 서버에게 전달 (이때, express 서버는 8080 서버에 열려있을 것 임)

그러면, express 서버가 프록시에게 응답 

응답받은 프록시는 클라이언트에게 보냄
```

![](https://i.imgur.com/5AN9Sjx.png)
![](https://i.imgur.com/ahKjGaB.png)





### aws 인스턴스 접속해서, ngix 설치 및 설정 | ⭐⭐⭐ 이 부분에서 오류가 많이 남 

#### 요약
``` bash
# nginx 설치 | 시스템 패키지를 설치하는 명령어는 디렉토리 위치와 관계없음! | 즉, cd 로 어디에 위치에서 하는지는 관계 없이 설치됨 
sudo apt install nginx

# nginx 시작 
sudo service nginx start

# nginx 상태 확인 
sudo service nginx status

# nginx 종료 
sudo service nginx stop


# nginx 설치해서 만들어진 default 에 접근해서 > '도메인 주소' , '서버 포트' 들어갈 수 있게 수정하기
	1) 절대 경로로 아래 주소 들어가기 👇👇 | ls -a 로 etc 를 찾아보려해도 안 찾아지니까, 당황하지 말 것. | 시스템의 루트 디렉토리 아래 가면 있음. ex) `ls /etc` | ⭐⭐⭐ 여기로 가서 nginx 수정 ⭐⭐⭐ 
	cd /etc/nginx/sites-enabled

	2) sudo vi default 로 default 파일 실행하기
	sudo vi default
		# CF. default 파일 : 가상 호스트 설정 파일



	3) 편집하고 싶은 곳으로 가서 i 누르고 편집 시작
	i 누르고 -> 편집 

	4) '도메인 주소' 및 '서버 포트' 적는 부분 
		- pass 에 '가비아' 가 에서 받은 도메인을 적어야? 아니면 고정 ip 를 적어야? 
		- 우선 이렇게 적음 
			1) location 에서 try_files 를 주석 처리 
			2) 나머지는 기재
				server_name busiman.shop;
					# 맞나❓❓❓❓❓❓❓ 노노노 틀림! 
					# [설명 by GPT] 보통 서버 이름에 URL을 입력하는 경우 `http://` 또는 `https://` 접두사를 생략해야 합니다. 예를 들어, `server_name http://busiman.shop;` 대신 `server_name busiman.shop;`과 같이 입력하면 됩니다.


			      location / {
                # First attempt to serve request as file, then
                # as directory, then fall back to displaying a 404.
                # try_files $uri $uri/ =404;

                proxy_set_header HOST $host;
                proxy_pass http://127.0.0.1:8080;
                proxy_redirect off;

	5) 다 적고 저장 
		i 모드에서 ESC 눌러서 빠져나와 -> : 누르고 -> wq! 

	6) 문법 오류 체크 
	sudo nginx -t
	
	 7) 재시작 
	sudo service nginx restart


> 들어가서, header, proxy_pass 변경


> 	설정파일 수정 코드 
	// location / {
	//     # First attempt to serve request as file, then
	//     # as directory, then fall back to displaying a 404.
	//     # try_files $uri $uri/ =404;
	
	//     proxy_set_header HOST $host;
	//     proxy_pass http://127.0.0.1:8080;
	//     proxy_redirect off;
	// }
	
		// proxy_set_header : 요청이 들어온 브라우저의 host 내용을 넘겨주겠다 
		// proxy_pass http://127.0.0.1:8080; : 80 으로 포트를 듣고 들어온 요청을 8080 포트로 전달 하겠다는 뜻 
		// proxy_redirect off; : spa(single page application) 일 경우, redirect 가 필요 없어서, redirect 를 없애겠다는 의미. | SPA 가 아니면, 굳이 써줄 필요가 없음
			// CF. SPA : 리액트, 뷰, 앵귤러 같은 

> 설정파일 수정 후 1) 설정 파일 정상인지 확인(문법 오류 있는지 체크)  2) 원래 경로로 가기 cd /home/ubuntu 3) '재시작' 해주기 	

	- 문법 오류 있는지 체크
	> sudo nginx -t

	- 재시작 
	> sudo service nginx restart

```


- nginx 상태 확인 : `sudo service nginx status`
![](https://i.imgur.com/06ArOPM.png)


- 해당 경로에서 `ls-a` 를 하면, `default` 파일이 있는 게 보임
```
ubuntu@ip-172-31-44-114:/home$ cd /etc/nginx/sites-enabled
ubuntu@ip-172-31-44-114:/etc/nginx/sites-enabled$ ls -a
.  ..  default
```
![](https://i.imgur.com/gF45onT.png)



- `cd /etc/nginx/sites-enabled` 들어가면 > 이렇게 보임
![](https://i.imgur.com/jpyJwOA.png)


- sudo vi default 로 default 파일 실행하는 모습 
![](https://i.imgur.com/gEETr5C.png)





도메인 써줄 공간 
![](https://i.imgur.com/0pMMM1F.png)


- 이렇게 수정 
헤더의 내용을 넘겨 주겠다는 말 
![](https://i.imgur.com/OWnjwZq.png)


리액트, view 쓸 때는 off 
![](https://i.imgur.com/ofSi2JF.png)
![](https://i.imgur.com/fBrdxiv.png)



- server 이름까지 해서 이렇게 작성하면 되나? 
	- server_name 은 도메인 이름? 
![](https://i.imgur.com/KgAR01G.png)





- 그러면, 8080 지워도 들어가짐 
![](https://i.imgur.com/WiDKLf5.png)

<br>



### [230818] nginx 백으로 요청 보낼 때 발생하는 axios 에러 해결하기 🚀🚀🚀 

#### 관련 명령어 요약 📚📚📚📚📚📚📚📚📚📚📚📚📚📚📚
``` bash
빌드 복사하고 가져오기 😥😥 


[nginx 에서 설정하는 default 파일로 이동 하기] | ❓ 이걸? | nginx 에서 프론트로 들어간가? 
	# 해당 디렉토리로 이동
	cd /etc/nginx/sites-enabled
	# 관리자 권한으로 default 파일 실행
	sudo vi default
	# 문법 체크 
	sudo nginx -t
	# nginx 재시작 | ⭐⭐ npm start 대신 이걸로... 응
	sudo service nginx restart
	# 상태 확인 
	sudo service nginx status


[PM2 작동 되는지 확인]
	# 백엔드 디렉토리로 이동
	ubuntu@ip-172-31-35-173:~/React_Project_NoBroker/backend$

	# 서버 종료 
	npx pm2 kill

	# 리스트 확인
	npx pm2 list

	# 다시 서버 켜기 
		#  package.json 에 "scripts": { "start": "pm2 start app.js" } 이렇게 정의되어 있다는 전제!!!!! ⭐⭐⭐  
	npm start

	# 다만, 테스트 할 때는, node app.js 를 켜놓는게 좋음 ⭐⭐⭐ | 그래야, 에러 또는 콘솔 메시지가 보임. 작업 다 끝나면 -> pm2 로 켜는 걸로 
	node app.js


[MySQL 관련 명령어]

	# 들어가기
	sudo mysql -u root -p
		# 여기서 mysql 비번 요구 : mysqlpwdj
		# sudo 는 관리자 권한으로 실행

	# 현재 My SQL 버전 확인 | mysql 로 들어가야 해⭐⭐⭐
	mysql> SELECT VERSION();

	# MySQL 재시작
	sudo service mysql restart 

	# MySQL 정상 작동중인지 확인 | Active: active (running) 나오면 됨 | 
	sudo systemctl status mysql


[vs code 에서 수정하고, build 본 지우고, build 본 다시 옮겨서, 다시 키기]
# 인스턴스에서 수정한 내용은 곧바로 git 에 push 를 해야 ❓❓ ⭐⭐⭐ 
	# 우선, 인스턴스에서 push 하는 건, 빼고 하기 

# vs code 에서 > front 폴더에서, npm run build 해주기
	# 전제로, front 폴더에서, 뭔가 바뀌어야 빌드가 됨.
npm run build

# 인스턴스에서 push 하고 -> 그 다음 vs code 에서 git 레퍼지토리로 push ❓❓ 

# sql 에서 충돌 발생했을 때 해결 예시 (https://sharegpt.com/c/BUkgT25)
	git add front/build/asset-manifest.json
	git add front/build/index.html
	git add front/build/static/js/main.4d661357.js
	git add front/build/static/js/main.4d661357.js.LICENSE.txt
	git add front/build/static/js/main.4d661357.js.map
	git add backend/app.js
	이렇게 변경사항을 저장하고 -> commit 하면 됨



[현재 임시 가입되어 있는 회원 정보]
const createTestUser = async () => {
    const userq = await User.findOne();
    if (!userq) {
        await User.create({user_id : "qwer", password :"qwer", role : true, user_name : "qwer", address : "주소", phone : "phone", ssn : "ssn"});
        await User.create({user_id : "qq", password :"qq", role : true, user_name : "qwer", address : "주소", phone : "phone", ssn : "ssn"});
    }

```





#### 문제 상황 
``` bash
[현재 상황]
- '/main, /login, /list' 페이지 등은 들어가짐


[list 페이지에서 아래와 같은 'test 코드' 에서 axios 에러 발생]
	1. 테스트 코드 스니펫
		'@PAC_MAP' 작성
		        console.log("axios : ", axios.defaults.baseURL);
		        const testFunc = async() => {
		            const test = await axios.get("/list/test" , {
		                withCredentials : true, 
		            });
		            console.log("test : " , test);
		        }
		        testFunc();

		'@estateListRouter' 작성 
				router.get("/test", (req, res)=>{
				    console.log("test요청 들어옴");
				    return res.json({test : "test", __dirname});
				});

	2. ['에러발생'] http://ec2-3-37-244-154.ap-northeast-2.compute.amazonaws.com/list 에서 PAC_MAP 컴포넌트 안에 있는 testFunc() 을 실행해서, "/list/test" 에 요청을 보내면, axios 에러가 남. 
{
    "message": "Request failed with status code 404",
    "name": "AxiosError",
    "stack": "AxiosError: Request failed with status code 404\n    at http://ec2-3-37-244-154.ap-northeast-2.compute.amazonaws.com/static/js/main.4d661357.js:2:1810497\n    at XMLHttpRequest.d (http://ec2-3-37-244-154.ap-northeast-2.compute.amazonaws.com/static/js/main.4d661357.js:2:1810645)",
    "config": {
        "transitional": {
            "silentJSONParsing": true,
            "forcedJSONParsing": true,
            "clarifyTimeoutError": false
        },
        "adapter": [
            "xhr",
            "http"
        ],
        "transformRequest": [
            null
        ],
        "transformResponse": [
            null
        ],
        "timeout": 0,
        "xsrfCookieName": "XSRF-TOKEN",
        "xsrfHeaderName": "X-XSRF-TOKEN",
        "maxContentLength": -1,
        "maxBodyLength": -1,
        "env": {},
        "headers": {
            "Accept": "application/json, text/plain, */*"
        },
        "baseURL": "/api",
        "withCredentials": true,
        "method": "get",
        "url": "/list/test"
    },
    "code": "ERR_BAD_REQUEST",
    "status": 404
}

	



	4. ['부분 정상작동'] http://ec2-3-37-244-154.ap-northeast-2.compute.amazonaws.com:8080/list/test 으로 요청을 보내면, 제대로 응답이 옴


{
-   "test": "test",
-   "__dirname": "/home/ubuntu/React_Project_NoBroker/backend/routers"
}



[생각해볼 점]
	1. nginx default 파일에서 설정을 아래와 같이 변경하면, 다른 오류가 나옴
	
				'@nginx default 에서 설정한 코드'
				location에 '/api'가 있는 경우
				        location = /api {
				                proxy_pass http://127.0.0.1:8080/; # 포트 번호를 8080으로 변경
				                proxy_set_header Host $host;
				                proxy_set_header X-Real-IP $remote_addr;
				                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
				        }
				
				location '/api'그 외의 경우
				        location ~ {
				                root /var/www/html/react-build;
				                # First attempt to serve request as file, then
				                # as directory, then fall back to displaying a 404.
				                try_files $uri $uri/ /index.html;
				
				                # proxy_set_header HOST $host;
				                # proxy_pass http://127.0.0.1:8000/;
				                # proxy_redirect off;
				        }


			'@브라우저 콘솔에서의 오류창'
				{
							    "data": "<!doctype html><html lang=\"en\"><head><meta charset=\"utf-8\"/><meta name=\"viewport\" content=\"width=device-width,initial-scale=1\"/><meta name=\"theme-color\" content=\"#000000\"/><script src=\"//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js\"></script><script src=\"//dapi.kakao.com/v2/maps/sdk.js?appkey=d8d02d00c2a92bc2ed0fba2820719bc9&libraries=services\"></script><title>React App</title><script src=\"https://files.worldwind.arc.nasa.gov/artifactory/web/0.9.0/worldwind.min.js\"></script><script src=\"https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js\"></script><script src=\"https://files.worldwind.arc.nasa.gov/artifactory/web/0.9.0/worldwind.min.js\" type=\"text/javascript\"></script><script src=\"../src/components/worldwind.js\" type=\"text/javascript\"></script><link rel=\"stylesheet\" href=\"./style.css\"/><script src=\"https://developers.google.com/maps/documentation/javascript/examples/markerclusterer/markerclusterer.js\"></script><script src=\"https://maps.googleapis.com/maps/api/js?key=AIzaSyB2Ks0HcfUkSKcjRU39pReueRDIofHxPio&libraries=places\"></script><script src=\"https://polyfill.io/v3/polyfill.min.js?features=default\"></script><script src=\"https://unpkg.com/supercluster@8.0.0/dist/supercluster.min.js\"></script><script defer=\"defer\" src=\"/static/js/main.4d661357.js\"></script><link href=\"/static/css/main.6cc6143a.css\" rel=\"stylesheet\"></head><body><div id=\"root\"></div></body></html>",
							    "status": 200,
							    "statusText": "OK",
							    "headers": {
							        "connection": "keep-alive",
							        "content-encoding": "gzip",
							        "content-type": "text/html",
							        "date": "Fri, 18 Aug 2023 01:02:10 GMT",
							        "etag": "W/\"64ddc910-584\"",
							        "last-modified": "Thu, 17 Aug 2023 07:15:28 GMT",
							        "server": "nginx/1.18.0 (Ubuntu)",
							        "transfer-encoding": "chunked"
							    },
							    "config": {
							        "transitional": {
							            "silentJSONParsing": true,
							            "forcedJSONParsing": true,
							            "clarifyTimeoutError": false
							        },
							        "adapter": [
							            "xhr",
							            "http"
							        ],
							        "transformRequest": [
							            null
							        ],
							        "transformResponse": [
							            null
							        ],
							        "timeout": 0,
							        "xsrfCookieName": "XSRF-TOKEN",
							        "xsrfHeaderName": "X-XSRF-TOKEN",
							        "maxContentLength": -1,
							        "maxBodyLength": -1,
							        "env": {},
							        "headers": {
							            "Accept": "application/json, text/plain, */*"
							        },
							        "baseURL": "/api",
							        "withCredentials": true,
							        "method": "get",
							        "url": "/list/test"
							    },
							    "request": {}
							}




[그러면, 어떤 걸 추가적으로 할 수 있나?]
	1. nginx default 파일을 수정? 
	2. 혹시, WORKBENCH 에서 지금 Tables could not be feteched 라서? 


```



- ['에러발생'] http://ec2-3-37-244-154.ap-northeast-2.compute.amazonaws.com/list 에서 PAC_MAP 컴포넌트 안에 있는 testFunc() 을 실행해서, "/list/test" 에 요청을 보내면, axios 에러가 남. 
![](https://i.imgur.com/3ew0oSs.png)
![](https://i.imgur.com/1XI9NGg.png)




- ['부분 정상작동'] http://ec2-3-37-244-154.ap-northeast-2.compute.amazonaws.com:8080/list/test 으로 요청을 보내면, 제대로 응답이 옴
![](https://i.imgur.com/ZPBtc1T.png)





#### 시도해본 것들 및 알게 된 것들


```
mysql 오류 해결하고 -> 제대로 backend 에서 신호 받아보자 
```
[[5. githubSync_gitBook/12_KGA_웹개발 블록체인 교육과정/KGA_08월(nobroker_react 프로젝트)/230816_노브로커_AWS배포#^684077]]




![](https://i.imgur.com/96k4cF2.png)




```
test 했을 때 발생하는 오류는 다시 작성하고 해보기 

```




















```
SSH 방식으로 입력했던 정보가 틀렸었음. 

그래서 SSH 방식으로 다시 들어가서 -> 맞는 정보로 수정하고 -> git push 

그게 권한 설정을 600 으로 해서, 이 부분이 먼저 적용되어 있던거 같은데 

```

![](https://i.imgur.com/Z8jaQR3.png)




```
주소를 
```


















### `탄력적 ip` 주소를 `도메인` 으로 교체

- 기본 설명
```
- 가비아에서 도메인을 구입해서 사용할 예정 
	- 1년 1만5000원 정도 나옴 

- 가비아 링크 : https://www.gabia.com/ 
- 도메인 구매 
```


- 검색하고, 도메인 선택, 포트폴리오를 쓸 예정 이니까
![](https://i.imgur.com/XUgqmfa.png)
![](https://i.imgur.com/ZzATr9v.png)





- chmod 를 777 로 설정함 
```
ubuntu@ip-172-31-35-173:~/React_Project_NoBroker/backend$ chmod 770 .env
```







#### 이 도메인을 사용해서 탄력적 ip 요청 갈 수 있게 만들기 


```
- aws Route 53 사용할 수 있게 하기
- 호스팅 
```


- aws Route 53 사용할 수 있게 하기
![](https://i.imgur.com/HT2LJU2.png)


- 호스팅 영역 클릭 > 가비아에서 구매한거 넣기 
![](https://i.imgur.com/xvDyv79.png)


- 상세 정보를 보면 레코드 
DNS 레코드는, 도메인의 이름과 관련된 정보를 나타내는 데이터 
![](https://i.imgur.com/hesVtHI.png)

- NS
	- name server. 인터넷에서 도메인을 ip 주소로 변환하는 역할. 
	- 도메인을 입력하면, 네임서버에게 '도메인 IP 주소' 를 요청한다. 
	- 그래서, 웹사이트에 접근할 수 있게 해준다. 


- 관리 버튼 누르고 들어가기 
![](https://i.imgur.com/Wh4HGf4.png)
![](https://i.imgur.com/jnxHmnX.png)

- 여기 AWS 에 있는거 있는거 하나 하나 옮겨줄 것 임 
![](https://i.imgur.com/gT0rzrZ.png)


- 점 빼고 입력 ⭐⭐⭐⭐⭐
![](https://i.imgur.com/DTxDDef.png)




#### 메인 도메인 레코드 추가 

```
[설명]
- A 레코드 : 도메인 이름은 V4 주소로 매핑 
- A 레코드에 탄력적IP 를 값으로 작성

[기입]
레코드 이름 : 공란 
레코드 유형 : A - IPv4 ... 
값 : 탄력적 ip 입력 (EC2에서 확인)
```

- 레코드 유형 
![](https://i.imgur.com/maebNun.png)
![](https://i.imgur.com/ROfFKJu.png)

<br>

#### 서브 도메인 레코드 추가 

```
[이론]
- CNAME 레코드 : 서브도메인으로 설정 
- www.blockchain9.co.kr 로 접속했을 때, blockchain9.co.kr 여기로 이동하게끔 해주는 개념

[기입]
레코드 유형 : CNAME
레코드 이름 : www
값 : busiman.shop 

CF. www.busiman.shop 으로 하면 -> busiman.shop 으로 연결된다. 
그래서, 이름에 www 적고, 값을 busiman1.shop 으로 한다. 

[실행]
pm2 설치하고 > pm2 로 서버 켜주고 > 실행 
주소는 'http://www.busiman.shop/login' 이렇게 입력
```

- 레코드 유형
![](https://i.imgur.com/p7jgdRj.png)

- 요소 기입 
![](https://i.imgur.com/vsp9Ywh.png)

- 결과 
![](https://i.imgur.com/xEcKEQ3.png)




#### 😥😥😥😥😥😥😥😥 pm2 다시 설치 하고 PM2 로 들어가보기 
- 나는 못 했으니까, 이걸로 다시 
- 그러면, npm start 로 시작하지 않아도 됨. 






#### HTTPS 로 보안 이슈 해결 


- 하고자 하는 것 
![](https://i.imgur.com/L6Hr5CY.png)


```
이걸 하려면 '검증된 사이트' 라는 '인증서' 가 필요. 
https 요청할 때, 인증서를 발급 받아서, 인증 요청을 하는데, 

https 설정
배포한 서버에 https 를 설정해서, 보안 이슈를 해결

인증서를 발급받을 곳은 무료로 인증서를 3개월짜리를 발급해주는 곳이 있음. 

'3개월 마다 재발급' 받아서, 무료 이용. 

'모질라' 라는 곳에서도 해줌 

지금은 certbot 이라는 사이트를 사용해서, https 를 간편하게 설정할 수 있다. 
장점은 3개월 마다, 우리가 직접, 인증서를 재발급, 받을 필요가 없이, ⭐알아서 재발급⭐ -> 메일로 알려줌

certbot nginx 랑도 호환이 좋습니다. 
간단하게 인증서 발급 갱신이 가능! 

공식 사이트 : https://certbot.eff.org/
```

<br>

- 공식 사이트 들어가서, 하고자 하는 서버 선택하면, 관련 설명이 나옴 
![](https://i.imgur.com/ooYUFtW.png)

<br>

``` powershell

- 설치 
sudo snap install core

- 업데이트 
sudo snap refresh core

sudo snap install --classic certbot

- certbot 실행파일에 링크 설정 
sudo ln -s /snap/bin/certbot /usr/bin/certbot

- nginx 관련 certbot 실행 
sudo certbot --nginx
	> 하다가 도메인 이름 넣기 
	
- nginx 에 default 파일 수정 


- 다시 경로로 돌아가기 
	> cd / home /ubuntu

- 문법 오류 확인 
	sudo nginx -t

- nginx 재시작 
	sudo service nginx restart

- 3개월 마다 재발급 명령어 
	sudo certbot renew

- 인증서 재발급 체크 
	- 실제로 인증서를 갱신하지 않고, 시뮬레이션으로 체크 
	- 발급할 때, 사전에 문제가 생길지 여부를 체크. 
	sudo certbot renew --dry-run

- [결과물]
	- 그러면, https 로 들어가서 '안전합니다.' 를 보여줄 수 있음. 
	- 그러면, https 가 필요한 지도, 등의 서비스를 연결할 수 있음. 


- ✅ 나중에 할 건 
	- 탄력적 ip 만 그 인스턴스에 연결 
	- 도메인도 연결 되어 있으니까, 
	- njs https 만 해주면 됨. 
```


- 도메인 이름 넣기 
![](https://i.imgur.com/orPQCUN.png)

- 여기로 들어가서 수정 ⭐⭐⭐⭐⭐⭐ 
![](https://i.imgur.com/CbIO4r4.png)


- 도메인 이름 이렇게 변경 
![](https://i.imgur.com/ICojrZc.png)

- 결과물 
	- 이 사이트는 안전합니다. 같은게 뜸 
	- `https` 로 도메인 시작 가능

![](https://i.imgur.com/KF44kbj.png)
![](https://i.imgur.com/vfB6c77.png)


<br>


## 가상 인스턴스 안에 SQL 연결하기 | DB 랑 연결해주기 

### 1. aws 인스턴스 에서 SQL 이랑 연결
``` bash
[sql 이랑 연결] ⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐

sudo apt-get update 
sudo apt-get install mysql-server
sudo mysql -u root -p
	# 여기서 mysql 비번 요구 : mysqlpwdj
	# sudo 는 관리자 권한으로 실행

# 이제 mysql 입장
create database nobroker;
	# mysql 에서는 세미콜론 무조건 ⭐⭐

create user 'admin'@'%' identified by 'admin1234';
	# admin 이라는 관리자 유저에게 권한을 주겠다는 의미 
	# admin1234 : 관리자로 입장하는 비번

grant all on nobroker.* to 'admin'@'%';
	# admin 관리자에게 nobroker 테이블에 대한 모든 권한을 허용

exit; 
	# sql 밖으로 나가기 

# 외부 접속 허용해주기
	# 1) 이쪽으로 들어가기 
	sudo vi /etc/mysql/mysql.conf.d/mysqld.cnf 
	# 2) bind-address 수정하기 
	 - bind-address : 127.0.0.1 -> 0.0.0.0 
		 # 이렇게 0.0.0.0 으로 수정하면 외부 접속 가능

# 변경된 파일 있으니까, mysql 서버 재실행 하기 
sudo service mysql restart 

```


### 2. Workbench 에서 연결

``` bash
1. aws 에서 퍼블릭 IPV4 DNS 가져오기 
	- 탄력적 ip 주소 아님! 
	- 퍼블릭 IPv4 DNS 임

2.. 벤치마크에서 할 것
	- connection name (자유롭게 ex) test3)
	- host name (퍼블릭 ipv4 dns 복사한 것 기재)
	- password (위에서 만든 것 기재)

3. AWS 에서 보안 그룹에 MYSQL 꼭 들어가 있어야 함!

```



- 워크벤치에서 `edit` 들어가기 
![](https://i.imgur.com/IsEBGQL.png)



- aws 에서 퍼블릭 IPV4 DNS 가져오기 
![[Pasted image 20230531114759.png]]


- 퍼블릭 ipv4, admin, 비밀번호 기입 
	- port 번호는 3306 으로 해도 무방
![](https://i.imgur.com/WXqvS3M.png)



![](https://i.imgur.com/WNB2Jvr.png)


- 완료되면, 이렇게 됨 
![](https://i.imgur.com/7wzIZa8.png)


- 혹시 이런 문제는? 
![](https://i.imgur.com/vI3Mpbd.png) ^a89b6f





### 3. not fetched 문제 해결 

^684077

- 다시 2차 파악 
``` sql
[원인]
- Error loading schema content Error Code: 1142 이 오류가 남 
- 권한이 없다는 말임. 
- 즉, '어디서 접속 하게 할건가.' 에 대한 권한은 와일드 카드('%') 에 의해 이미 부여됨
- 다만, '어떤 작업을 수행 하게 할 것 인가' 는 아직 부여가 안 된 상황

[현재상황]
-- 현재 유저 확인
mysql> SELECT user, host FROM mysql.user;
		-- admin 이 와일드 카드 권한(모든 ip 에서 접속 가능한 권한) 을 갖고 있음. 


[오류 메시지 파악]
- Error Code: 1142 SELECT command denied to user 'admin'@'221.149.9.93' for table 'user_variables_by_thread'	
	> user_variables_by_thread 테이블에 대한 SELECT 권한이 없어서 생기는 문제

- user_variables_by_thread 테이블은 어디에 있는거지? 
		'mysql> SHOW DATABASES;' 를 하면 기본적으로 존재하는 database 가 나옴 | 이 중 내가 만든건 nobroker 하나 뿐임 
		+--------------------+
		| Database           |
		+--------------------+
		| information_schema |
		| mysql              |
		| nobroker           |
		| performance_schema |
		| sys                |
		+--------------------+

		'mysql> USE performance_schema;' 를 통해, 해당 database 하위에 어떤 table 이 있는지 확인 

		그 결과, 'performance_schema' database 안에 'user_variables_by_thread' 테이블이 있었음. 


[해결 코드]
-- 그래서 해당 테이블에 대한 SELECT 권한을 부여 | ⭐⭐ | 해결 코드 🔵	
		mysql> GRANT SELECT ON performance_schema.user_variables_by_thread TO 'admin'@'221.149.9.93';


-- 변경된 권한 즉시 반영
FLUSH PRIVILEGES;

-- 나가기 
exit;



```



- 오류 메시지 
![](https://i.imgur.com/zCkSnYE.png)


- 현재 사용 유저 
![](https://i.imgur.com/X7TH6UC.png)



- mysql> USE performance_schema;' 를 통해, 해당 database 하위에 어떤 table 이 있는지 확인
``` sql
mysql> USE performance_schema;
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
mysql> SHOW TABLES;
+------------------------------------------------------+
| Tables_in_performance_schema                         |
+------------------------------------------------------+
 -- 중간에 다양한 속성들이 나옴 | 생략 |

| user_defined_functions                               |
| user_variables_by_thread ⭐⭐⭐ 이게 나옴   |
| users                                                |
| variables_by_thread                                  |
+------------------------------------------------------+
111 rows in set (0.00 sec)

```


- not fetched 사라짐
![](https://i.imgur.com/rlJ3Ibc.png)






- 잘못 파악 
``` bash
[원인]
- Tables could not be fetched 는 mysql 버전이 upgrade 가 되지 않아서 발생 (https://anow.tistory.com/276)

[mysql 버전 업그레이드 하려면]
- MySQL 버전 8.0 이전과 이후에 업그레이드 방식이 다름 (https://myinfrabox.tistory.com/9)

		[업그레이드 프로그램] 
		8.0.16 미만 : mysql_upgrade
		8.0.16 이상 : mysqld
		
		[최소 업그레이드만 진행] | SQL 이 아니라, 일반 터미널에서 진행 
		8.0.16 미만 : mysql_upgrade --upgrade-system-tables
		8.0.16 이상 : mysqld --upgrade=MINIMAL


# 업그레이드 진행
sudo service mysql stop
sudo mysqld --upgrade=MINIMAL
sudo service mysql start


```

![](https://i.imgur.com/vbIJxIu.png)














## `.env` 파일 만들기 


### `인스턴스` 자체에서 ENV 만들기 

```
어떤 명령어인지 정확히 기억은 안남 
SSH 방식과 동일한 화면이 나옴 
```


### 'SSH 방식' 으로 환경 변수 설정하기 
``` bash
# aws 에서 확인할 수 있는 것들 
	- aws  ssh 연결 방식 탭에 가면 'ssh -i "noBroker.pem" ubuntu@ec2-3-37-244-154.ap-northeast-2.compute.amazonaws.com' 이렇게 나와있음. 
	- 'ssh -i "noBroker.pem" ubuntu@ec2-3-37-244-154.ap-northeast-2.compute.amazonaws.com' 여기에서, 할당받은 퍼블릭 ipv4 를, ssh -i "noBroker.pem" ubuntu@ + '퍼블릭 ipv4 주소' 에 넣을 수 있음.

# [연결하기] ⭐⭐⭐ | 이게 작동함🔵
	chmod 600 keyname.pem  # 다만, 이렇게 chmod 를 넣으면, ssh 으로만 env 를 수정할 수 있음. 따라서 주의해야 함 ⭐⭐⭐ 
	ssh -i ./keyname.pem ubuntu@퍼블릭 ipv4 주소

# [nobroker 실행 코드] | 이렇게 하면, aws 만든곳이랑 SSH 방식으로 연결됨
ssh -i  "noBroker.pem" ubuntu@ec2-3-37-244-154.ap-northeast-2.compute.amazonaws.com

# [env 파일 편집하는 곳에 접근]
	sudo nano /etc/environment

# [이렇게 해서 환경변수 추가]
	DATABASE_NAME=nobroker
	DATABASE_USERNAME=root   # 혹시, username 이 admin 인가❓❓❓ 
	DATABASE_PASSWORD=980214
	DATABASE_HOST=127.0.0.111
	ACCESS_TOKEN_KEY=qweqwe
	SESSION_KEY=zxczxc

#  [파일 저장하고 닫기]
	CNTL + O
	ENTER 
	CNTL + X 

# [다시 실행]
	sudo reboot
	또는 sudo systemctl restart your-service

# [적용되었나 확인] 찍혀나오긴 하는데 좀 더봐야 함 
	'printenv DATABASE_NAME'
	또는 'echo $DATABASE_NAME'


# 다시, 'chmod 770 .env' 이걸로 변경 ⭐⭐⭐ 
	ubuntu@ip-172-31-35-173:~/React_Project_NoBroker/backend$ chmod 770 .env
  
```

- SSH 연결 성공 모습 
	- 사전에 nobroker 폴더에 pem 이 들어가 있는 상태 ⭐⭐⭐ 
	- chmod 로 먼저 권한 변경하고 
	- 그 다음 ubuntu 이름 써서 연결
![](https://i.imgur.com/LbLtJ65.png)


- 중요한건 '띄어쓰기를 하면 안 됨.' | 다닥 다닥 붙여 써야 함 ⭐⭐⭐⭐⭐⭐ 
![](https://i.imgur.com/FUpoNjK.png)











## 프론트를 빌드하고 -> 빌드 파일을 인스턴스의 루트 디렉토리로 가져와서 -> 리액트앱을 실행하기 ⭐⭐⭐ 


``` bash 
[front 에서 build]
1. npm run build
2. 그러면, build 폴더가 생김
3. git 에 push 함 
4. 인스턴스에서 git pull 로 받음 | 이때, 이미 연결된게 있다면 거기 디렉토리에서 하면 됨
5. 다운받은 build 폴더를, 웹 서버의 루트 디렉토리('var/www/html') 로 이동 하거나 복사 


[다운받은 build 폴더를, 웹 서버의 루트 디렉토리('var/www/html') 로 이동 하거나 복사]
	# 1. 깃 클론 받기 
	git clone https://github.com/your-username/my-react-project.git

	# 2. `my-react-project` 디렉토리로 이동 | 이때, 상황에 맞는 프로젝트 이름 기재 
	cd my-react-project

	# 3. 'build' 디렉토리를 웹 서버의 루트 디렉토리('var/www/html') 로 이동 ⭐⭐⭐⭐⭐ 
	sudo mv build /var/www/html/my-react-app
		# sudo mv build /var/www/html/react-build | 이거 였나? 
		# /var/www/html 에 저장하는 이유 : var 는 로그, 캐시 등 다양한 가변 데이터를 저장 | var/www 는, 웹 페이지의 정적 파일을 저장하는 곳 | /var/www/html 는 서버가 클라이언트의 요청을 받을 때, 제공하는 기본 경로 

이때, 📛📛📛📛📛📛 뭐 이런걸 했음. 
	rm rt 하고 
	mv 하고 
	sudo service nginx start



	# 4. 웹 서버 재시작 
	sudo systemctl restart nginx

	# 5. 배포된 리액트 앱의 도메인 또는 IP 주소를 사용하여 앱에 접속. 
	ec2-3-37-244-154.ap-northeast-2.compute.amazonaws.com (`퍼블릭 IPv4 DNS` 주소 입력)


```

- vs code 에서 `run build` 하는 모습 
![](https://i.imgur.com/Rmv2F3p.png)


- build 폴더가 생김
![](https://i.imgur.com/d1wFbjO.png)

- 빌드 폴더를 aws 인스턴스에서 새롭게 만드는 과정
![](https://i.imgur.com/FeOuvdT.png)



## backend 랑 frontend 랑 둘 다 npm start 해야 하는데, backend 는 pm2 로 실행되게 해놓기? 



- 출처 : [[3. Resource_리소스/Node.js/KGA_14주~17주차(6월) - 복사본/2305310927_수요일_node.js_AWS 배포_도메인연결_EC2방식#^b7b3e6]]

``` js
- 백그라운드에 서버가 계속 대기할 수 있게 
	1. pm2 설치 
	npm i pm2 

	2. package.json 부분에서 실행 스크립트 명령어를 node app.js 로 실행했을 텐데 > 이걸 pm2 start app.js 로 수정 > 그러면, 서버가 종료 되어도, 백그라운드에서 노드 서버가 실행

		2.1 package.json 파일 자체로 수정하면 안 될 수 있음. 그러면, i 로 직접 수정에 접근해서 진행
			a) ubuntu@ip-172-31-36-225:~/20230522$ vi package.json | 변경하고 싶은 package.json 접근 
			b) 수정하고 싶은 key 는 "start" 임. > start 에서 i 누른다. > "start" : "pm2 start app.js" 로 변경 > `:wq!` 키워드 써서, 저장후 종료 
			c) 그러면, cntrl c 를 눌러서 서버를 꺼도, 들어갈 수 있다는 말임. 
			d) 결국, 'npm start' 하면 -> pm2 를 활용해서 서버가 계속 켜짐 

	3. 서버 종료는 
		npx pm2 kill

	4. 리스트 확인 
		npx pm2 list

	5. ❓❓ 그 다음 pm2 재시작이 있지 않을까? 
```


## HTTPS 로 보안 이슈 해결 


- 하고자 하는 것 
![](https://i.imgur.com/L6Hr5CY.png)


```
이걸 하려면 '검증된 사이트' 라는 '인증서' 가 필요. 
https 요청할 때, 인증서를 발급 받아서, 인증 요청을 하는데, 

https 설정
배포한 서버에 https 를 설정해서, 보안 이슈를 해결

인증서를 발급받을 곳은 무료로 인증서를 3개월짜리를 발급해주는 곳이 있음. 

'3개월 마다 재발급' 받아서, 무료 이용. 

'모질라' 라는 곳에서도 해줌 

지금은 certbot 이라는 사이트를 사용해서, https 를 간편하게 설정할 수 있다. 
장점은 3개월 마다, 우리가 직접, 인증서를 재발급, 받을 필요가 없이, ⭐알아서 재발급⭐ -> 메일로 알려줌

certbot nginx 랑도 호환이 좋습니다. 
간단하게 인증서 발급 갱신이 가능! 

공식 사이트 : https://certbot.eff.org/
```

<br>

- 공식 사이트 들어가서, 하고자 하는 서버 선택하면, 관련 설명이 나옴 
![](https://i.imgur.com/ooYUFtW.png)

<br>

``` powershell

- 설치 
sudo snap install core

- 업데이트 
sudo snap refresh core

sudo snap install --classic certbot

- certbot 실행파일에 링크 설정 
sudo ln -s /snap/bin/certbot /usr/bin/certbot

- nginx 관련 certbot 실행 
sudo certbot --nginx
	> 하다가 도메인 이름 넣기 
	
- nginx 에 default 파일 수정 


- 다시 경로로 돌아가기 
	> cd / home /ubuntu

- 문법 오류 확인 
	sudo nginx -t

- nginx 재시작 
	sudo service nginx restart

- 3개월 마다 재발급 명령어 
	sudo certbot renew

- 인증서 재발급 체크 
	- 실제로 인증서를 갱신하지 않고, 시뮬레이션으로 체크 
	- 발급할 때, 사전에 문제가 생길지 여부를 체크. 
	sudo certbot renew --dry-run

- [결과물]
	- 그러면, https 로 들어가서 '안전합니다.' 를 보여줄 수 있음. 
	- 그러면, https 가 필요한 지도, 등의 서비스를 연결할 수 있음. 


- ✅ 나중에 할 건 
	- 탄력적 ip 만 그 인스턴스에 연결 
	- 도메인도 연결 되어 있으니까, 
	- njs https 만 해주면 됨. 
```


- 도메인 이름 넣기 
![](https://i.imgur.com/orPQCUN.png)

- 여기로 들어가서 수정 ⭐⭐⭐⭐⭐⭐ 
![](https://i.imgur.com/CbIO4r4.png)


- 도메인 이름 이렇게 변경 
![](https://i.imgur.com/ICojrZc.png)

- 결과물 
	- 이 사이트는 안전합니다. 같은게 뜸 
	- `https` 로 도메인 시작 가능

![](https://i.imgur.com/KF44kbj.png)
![](https://i.imgur.com/vfB6c77.png)





---



## 배포 이후 잔버그들 

### 1. range 버튼이 없네 ㅠㅠ 
```
range 버튼이 없네 ㅠㅠ 음 이건 api 가 없다는 거지? 
그러면, 로컬 파일이랑 인스턴스랑 비교 필요 
```
![](https://i.imgur.com/ZLdMftj.png)




## [230823] 다시 배포 


``` bash 
- 다시 git 지우고 

[문제 상황]
http://3.37.244.154 이렇게 써야 됨...

[이슈]
1. env 파일 과 api 키 받는 문제 
2. 파일 가져올 때의 문제 | css, 이미지 파일 
```


![[Pasted image 20230823194643.png]]



---




# [230823] 다시 배포 시도 | 좀 더 추가적으로 해야 좀 더 깔끔하게 정리 될 듯 



## 현재 상황 정리 
``` bash
1. env 설정 관련해서 오류가 있어서, api 연결해야 하는 부분이 작동하지 않음 
	ex) 카카오 api 


2. 현재, css 및 이미지 파일이 가져와지지 않는 부분이 있음. 
	- public 폴더에 넣어야 하는 것으로 추정 (경로 문제)
	- https://pak-fuse.tistory.com/48 (이걸 해봐도 좋을듯)
```



## 해보기 


### 0. 단계별 필수 체크 사항 


- [vs code 작성하면서 확인할 것]
	- 프록시 경로 (참고  : [[5. githubSync_gitBook/12_KGA_웹개발 블록체인 교육과정/KGA_08월(nobroker_react 프로젝트)/230816_노브로커_AWS배포#^09ba52]]) #📛📛📛_보완필요_잘모르겠음 
		- 왜 front/src 랑 component/serverURL 이 필요한거지?


- [vs code 에서 작성하고 난 다음]
	- 반드시 npm run build 해야 함 




### 1. AWS 에서 인스턴스 만들기 

#### 명령어 요약 
- 출처 : [[5. githubSync_gitBook/12_KGA_웹개발 블록체인 교육과정/KGA_08월(nobroker_react 프로젝트)/230816_노브로커_AWS배포#EC2 인스턴스 만들고 연결하기]]
``` bash
1. aws EC2 인스턴스 들어가기


1. 체크할 것 
	- '지역 = 서울' 인지 여부 
	- 이름 = 자유 기재 
	- 사용운영 체재 = '우분투 / 프리미어' (필수) ⭐⭐⭐⭐⭐⭐ 
	- 키페어 
		- 키페어 이름 자유롭게 설정 
		- RSA, .per 으로 설정 
		- 생성된 mykey.pem 파일을 '전송' 할 일이 있으면, '반드시 usb로' (이메일하거나, 노출되면 안 돼) | ⭐⭐⭐ 키 파일 보관 잘 하기 
	- 네트워크 설정 
		- 보안그룹 설정 : HTTP, HTTPS, MYSQL | ⭐⭐⭐ MYSQL 필수 
		- 원본 : 0.0.0./0 으로 설정 

2. 다 만들어지면 > EC2 전체 화면에서 > 우측 상단 클릭 

3. 수업에서는 SSH 클라이언트로 연결

```


### 2. SQL 과 AWS 연결하기 (인스턴스 방식으로 연결) 

#### ubuntu 디렉토리에서 git 설치 (출처 : [[5. githubSync_gitBook/12_KGA_웹개발 블록체인 교육과정/KGA_08월(nobroker_react 프로젝트)/230816_노브로커_AWS배포#ubuntu 디렉토리에가서 -> git 설치]])
``` bash
[ubuntu 디렉토리로 이동]
cd /home/ubuntu
	Cf. 이 디렉토리로 이동하는 이유는 'cd ~' 로 하면 도착하는 홈 디렉토리이기 때문

[혹은 ls -a 로 파일 확인하고 이동]
cd ../ 
ls -a 

[도착하면]
git init
```



#### nvm 설치 후 git 연결 | 1) nvm 설치하고, 2) git clone 해서 git 연결하고 3)  backend, frontend 의 package.json 있는 폴더에서 의존성 설치(npm install) 하기 
	- 출처 : [[230816_노브로커_AWS배포#nvm 설치 후 git 연결 1) nvm 설치하고, 2) git clone 해서 git 연결하고 3) backend, frontend 의 package.json 있는 폴더에서 의존성 설치(npm install) 하기]]

``` bash
# 노드 설치 
# nvm 노드 버전 매니저 
    // node.js 설치 하고, 다른 버전으로 설치 할 때, 
    // 삭제하고, 다시 설치할 필요 없이, 버전관리가 편하다. 
    // 원하는 버전을 설치 받고, 바로 스위치 가능 

    # 첫 번째 설치 | `install.sh` 스크립트를 다운로드만 하고 실행하지 않음
	#curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.37.2/install.sh
    
    # 🔵 두 번째 방법으로 설치 | 👇 아래 코드를 그대로, 넣으면 설치됨 | `install.sh` 스크립트를 다운로드하고 실행까지 함 | 🔵 두 번째 방법으로 하면 됨. 
    curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.37.2/install.sh | bash 

    # 소스 파일 적용 | bashrc 😥😥😥 이게 설정이 안 되어 있었다는 것? 😥😥😥  
	source ~/.bashrc

		# bashrc 파일에 nvm 관련 설정이 제대로 들어갔는지 확인 | 뭔가 나오면, 제대로 설치 된 것  
			cat ~/.bashrc | grep nvm


    # 전체 목록 확인
	nvm list-remote
		# 에러날 수 있음 -> 당황하지 않고 다음으로 넘어가기

    # 원하는 버전을 선택하고 설치 
    nvm install 16(여기서 숫자 버전)

	# nobroker 프로젝트 git 을 복사해오기 
		# EC2 에서 어떤 폴더에 할지 고민인데, 지금은 우선 Ubuntu 안에 하자
		# [tip] 이 순간, cd ~ 을 하면, 가장 home 으로 가게 됨. | 이게 ubuntu 폴더 임. 
		git clone https://github.com/zam0ng/React_Project_NoBroker.git
			# 수정할 수 있는 부분
				# 1) mkdir /home/ubuntu/projects 이런 디렉토리에 설치할 수도


	# ls -a 하면, 만들어진 프로젝트가 있는데 거기로 이동 -> package.json 이 있는 곳으로 이동해서 npm install 로 의존성 설치 
	cd React_Project_NoBroker
	cd front 또는 cd backend
	npm install 
	
    # 노드 모듈 설치 
    npm i 
    npm start 
```




#### 탄력적 ip 추가하기 
- 출처 : [[5. githubSync_gitBook/12_KGA_웹개발 블록체인 교육과정/KGA_08월(nobroker_react 프로젝트)/230816_노브로커_AWS배포#탄력적 ip 추가 하기]]



#### Route53 에서 퍼블릭 ipv4 값 넣기 
 - 출처 : [[5. githubSync_gitBook/12_KGA_웹개발 블록체인 교육과정/KGA_08월(nobroker_react 프로젝트)/230816_노브로커_AWS배포#Route 53 에서 퍼블릭 ipv4 값을 넣어주기]]



#### 가상 인스턴스 안에 SQL 연결 | DB 랑 연결 
- 출처 : [[5. githubSync_gitBook/12_KGA_웹개발 블록체인 교육과정/KGA_08월(nobroker_react 프로젝트)/230816_노브로커_AWS배포#가상 인스턴스 안에 SQL 연결하기 DB 랑 연결해주기]]


##### 1. aws 인스턴스에서 sql 이랑 연결 셋팅 | 1) database 생성 2) 관리자 계정 및 권한 부여 3) 외부 접속 허용
``` bash 
[sql 이랑 연결] ⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐⭐

sudo apt-get update 
sudo apt-get install mysql-server
sudo mysql -u root -p
	# 여기서 mysql 비번 요구 : mysqlpwdj | 내 workbench 비번을 대면 됨
	# sudo 는 관리자 권한으로 실행

# 이제 mysql 입장
create database nobroker;
	# mysql 에서는 세미콜론 무조건 ⭐⭐

# 관리자 계정 및 비번 설정 
create user 'admin'@'%' identified by 'admin1234';
	# admin 이라는 관리자 유저에게 권한을 주겠다는 의미 
	# admin1234 : 관리자로 입장하는 비번

# 관리자 계정에게 모든 권한 주기
grant all on nobroker.* to 'admin'@'%';
	# admin 관리자에게 nobroker 테이블에 대한 모든 권한을 허용
	# 다만, 이후 권한 이슈가 발생하게 될 텐데 이 부분에서 추가해줘야 하는게 있지 않을까❓❓❓ 


exit; 
	# sql 밖으로 나가기 

# 외부 접속 허용해주기
	# 1) 이쪽으로 들어가기 
	sudo vi /etc/mysql/mysql.conf.d/mysqld.cnf 
	# 2) bind-address 수정하기 
	 - bind-address : 127.0.0.1 -> 0.0.0.0 
		 # 이렇게 0.0.0.0 으로 수정하면 외부 접속 가능
	# 3) 작성 다 하고 

# 변경된 파일 있으니까, mysql 서버 재실행 하기 
sudo service mysql restart 
```



##### 2. workbench 에서 연결 
- 출처 : [[5. githubSync_gitBook/12_KGA_웹개발 블록체인 교육과정/KGA_08월(nobroker_react 프로젝트)/230816_노브로커_AWS배포#2. Workbench 에서 연결]]
``` bash 
1. aws 에서 퍼블릭 IPV4 DNS 가져오기 
	- 탄력적 ip 주소 아님! 
	- 퍼블릭 IPv4 DNS 임

2.. 벤치마크에서 할 것
	- connection name (자유롭게 ex) test3)
	- host name (퍼블릭 ipv4 dns 복사한 것 기재)
	- password (위에서 만든 것 기재)

3. AWS 에서 보안 그룹에 MYSQL 꼭 들어가 있어야 함!

4. 이렇게 하면, not fetched 문제가 발생하는데, 해결해야 함 
```


##### 3. not fetched 문제 해결 📛📛📛📛📛📛 
- 출처 : [[5. githubSync_gitBook/12_KGA_웹개발 블록체인 교육과정/KGA_08월(nobroker_react 프로젝트)/230816_노브로커_AWS배포#3. not fetched 문제 해결]]
``` bash
# 230824 아직 안 해봤음 📛

# [해결 코드]
# -- 그래서 해당 테이블에 대한 SELECT 권한을 부여 | ⭐⭐ | 해결 코드 🔵	
		mysql> GRANT SELECT ON performance_schema.user_variables_by_thread TO 'admin'@'221.149.9.93';


# 변경된 권한 즉시 반영
FLUSH PRIVILEGES;

# 나가기 
exit;

```





### 3. Nginx 사용해서, 프록시 설정

- aws 인스턴스 접속해서, nginx 설치 및 설정 
	- 출처 : [[5. githubSync_gitBook/12_KGA_웹개발 블록체인 교육과정/KGA_08월(nobroker_react 프로젝트)/230816_노브로커_AWS배포#aws 인스턴스 접속해서, ngix 설치 및 설정 ⭐⭐⭐ 이 부분에서 오류가 많이 남]]
``` bash 
# 버전 업그레이드 
	sudo apt update #처음에 할 때는 이거 없이 되었는데, 지금 3번째로 배포작업 할 때는 오류 나서 이 부분 넣음 


# nginx 설치 | 시스템 패키지를 설치하는 명령어는 디렉토리 위치와 관계없음! | 즉, cd 로 어디에 위치에서 하는지는 관계 없이 설치됨 
sudo apt install nginx

# nginx 시작 
sudo service nginx start

# nginx 상태 확인 
sudo service nginx status

# nginx 종료 
sudo service nginx stop


# nginx 설치해서 만들어진 default 에 접근해서 > '도메인 주소' , '서버 포트' 들어갈 수 있게 수정하기
	1) 절대 경로로 아래 주소 들어가기 👇👇 | ls -a 로 etc 를 찾아보려해도 안 찾아지니까, 당황하지 말 것. | 시스템의 루트 디렉토리 아래 가면 있음. ex) `ls /etc` | ⭐⭐⭐ 여기로 가서 nginx 수정 ⭐⭐⭐ 
	cd /etc/nginx/sites-enabled

	2) sudo vi default 로 default 파일 실행하기
	sudo vi default
		# CF. default 파일 : 가상 호스트 설정 파일



	3) 편집하고 싶은 곳으로 가서 i 누르고 편집 시작
	i 누르고 -> 편집 

	4) '도메인 주소' 및 '서버 포트' 적는 부분 
		- pass 에 '가비아' 가 에서 받은 도메인을 적어야? 아니면 고정 ip 를 적어야? 
		- 우선 이렇게 적음 
			1) location 에서 try_files 를 주석 처리 
			2) 나머지는 기재
				server_name busiman.shop;
					# 맞나❓❓❓❓❓❓❓ 노노노 틀림! 
					# [설명 by GPT] 보통 서버 이름에 URL을 입력하는 경우 `http://` 또는 `https://` 접두사를 생략해야 합니다. 예를 들어, `server_name http://busiman.shop;` 대신 `server_name busiman.shop;`과 같이 입력하면 됩니다.


			      location / {
                # First attempt to serve request as file, then
                # as directory, then fall back to displaying a 404.
                # try_files $uri $uri/ =404;

                proxy_set_header HOST $host;
                proxy_pass http://127.0.0.1:8080;
                proxy_redirect off;

	5) 다 적고 저장 
		i 모드에서 ESC 눌러서 빠져나와 -> : 누르고 -> wq! 

	6) 문법 오류 체크 
	sudo nginx -t
	
	 7) 재시작 
	sudo service nginx restart


> 들어가서, header, proxy_pass 변경


> 	설정파일 수정 코드 
	// location / {
	//     # First attempt to serve request as file, then
	//     # as directory, then fall back to displaying a 404.
	//     # try_files $uri $uri/ =404;
	
	//     proxy_set_header HOST $host;
	//     proxy_pass http://127.0.0.1:8080;
	//     proxy_redirect off;
	// }
	
		// proxy_set_header : 요청이 들어온 브라우저의 host 내용을 넘겨주겠다 
		// proxy_pass http://127.0.0.1:8080; : 80 으로 포트를 듣고 들어온 요청을 8080 포트로 전달 하겠다는 뜻 
		// proxy_redirect off; : spa(single page application) 일 경우, redirect 가 필요 없어서, redirect 를 없애겠다는 의미. | SPA 가 아니면, 굳이 써줄 필요가 없음
			// CF. SPA : 리액트, 뷰, 앵귤러 같은 

> 설정파일 수정 후 1) 설정 파일 정상인지 확인(문법 오류 있는지 체크)  2) 원래 경로로 가기 cd /home/ubuntu 3) '재시작' 해주기 	

	- 문법 오류 있는지 체크
	> sudo nginx -t

	- 재시작 
	> sudo service nginx restart
```



- 이번에는 이렇게 저번에 작성한대로 함 
- 프록시 설정 | 출처 : [[5. githubSync_gitBook/12_KGA_웹개발 블록체인 교육과정/KGA_08월(nobroker_react 프로젝트)/230816_노브로커_AWS배포#교수님이 해주신 부분]]
``` js
= , ~ 을 설정하여, api 하위 요소가 붙어서, 요청이 들어갈 수 있는 가능성을 알게 됨  
```
![](https://i.imgur.com/nW6k81z.png)
![[Pasted image 20230824084159.png]]
![[Pasted image 20230824084212.png]]

``` nginx
        # Add index.php to the list if you are using PHP
        index index.html index.htm index.nginx-debian.html;
                root /var/www/html/react-build;
                # First attempt to serve request as file, then

                   # 백엔드 프로젝트 설정
        location /api{
                # proxy_pass http://127.0.0.1:8080; # 포트 번호를 8080으로 변경
                proxy_set_header Host $host;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        location /{
                root /var/www/html/react-build;
                # First attempt to serve request as file, then
                # as directory, then fall back to displaying a 404.
                try_files $uri $uri/ /index.html;

                # proxy_set_header HOST $host;
                # proxy_pass http://127.0.0.1:8000;
                # proxy_redirect off;

        }
```





### 4. env 파일 만들기 

- 출처 : [[5. githubSync_gitBook/12_KGA_웹개발 블록체인 교육과정/KGA_08월(nobroker_react 프로젝트)/230816_노브로커_AWS배포#'SSH 방식' 으로 환경 변수 설정하기]]
	- 이 방식은 노브로커 배포 초기 셋팅임 
	- ssh 방식에서 chmod 에서 권한 설정을 ssh 로만 몰빵해줘서, 인스턴스에서 수정하기가 어려웠고, 꼬였음. 
- 출처 : https://cordcat.tistory.com/118
	- 비슷한걸 말하고 있는거 같긴 한데



``` bash
# bashrc 찾기
	#ubuntu@~~~~/home/ubuntu 에 있습니다.  
	#따라서 본인 경로에서 cd ..를 통해 본인의 경로를 찾은뒤 home/ubuntu에서 # ls -al 을 통해 .bashrc를 찾습니다.

# bashrc 실행
nano .bashrc

# 맨 아래에 작성 

# 나가기 
cntrl x 
y 
enter

# 변경한 환경변수 적용하기 
source .bashrc

# 제대로 적용 되었는지 확인하기 
echo $DATABASE_NAME
	# 이렇게 하면, nobroker 가 나와야 함 

```

- 1차 작성
![[Pasted image 20230824093100.png]]




### 5. 빌드 

- 출처 : [[5. githubSync_gitBook/12_KGA_웹개발 블록체인 교육과정/KGA_08월(nobroker_react 프로젝트)/230816_노브로커_AWS배포#프론트를 빌드하고 -> 빌드 파일을 인스턴스의 루트 디렉토리로 가져와서 -> 리액트앱을 실행하기 ⭐⭐⭐]]
- 출처 : 가상 메모리 할당 하기 (https://kth990303.tistory.com/361)

- 새롭게 해볼 것 
``` bash
# 인스턴스에서 바로 빌드 
	- 이렇게 하려면, node 에서 apt 어쩌구를 하고 하면 됨
		- 음... 이전에 한걸 찾아보니까, nginx 할 때 apt 한거 같음 

# 빌드 된 파일을 프록시 상 프론트 루트 폴더로 옮기기
	sudo rm -r var/www/html/react-build 로 지우고 - 확인하고 
	sudo mv build /var/www/html/react-build

```

- 인스턴스에서 npm run build 할 때 생긴 오류 -> 1. `npm install @babel/plugin-proposal-private-property-in-object --save-dev` 이걸 넣어서 -> 다시 npm run build 해봄 
![[Pasted image 20230824093855.png]]
``` bash
# [☝☝ 이 오류 진행 과정]
- 오래 걸려서 가상 메모리 받아야 할 듯 
	- 여기 가서 하면 됨 : https://kth990303.tistory.com/361 
		- 가상 메모리 추가로 받고 -> 다시 npm run build 하니까 됨
```

(가상 메모리 추가로 받고 -> 다시 npm run build 하니까 된 모습)
![[Pasted image 20230824095352.png]]












### ✅ 다음 버전에 추가할 사항 및 궁금증
``` bash
- css 안 되는 건, index.css 를 index.html 의 style 에 밀어넣으니까 됨 
- 빌드를 인스턴스 프론트에서 함 응? 음. 그럼 그 복사 하는 건? ❓❓❓ 


```









